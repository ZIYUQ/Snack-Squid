<section id="findVan">
    <script src="https://api.mqcdn.com/sdk/mapquest-js/v1.3.2/mapquest.js"></script>
    <link type="text/css" rel="stylesheet" href="https://api.mqcdn.com/sdk/mapquest-js/v1.3.2/mapquest.css" />


    <div id="map" style="width: 50%; height: 530px;"></div>
    {{#each Vans}}
    <div class="vanListing">
        <span class="vanName">{{this.vanName}}</span>
        <span class="vanLocation">{{this.location}}</span>
        <span class="vanId">{{this._id}}</span>
        <button id="chooseVan"> This Van! </button>
    </div>
    {{/each}}

    <script type="text/javascript">

        let vans = document.querySelectorAll('.vanListing')
        console.log(vans)
        for (let i = 0; i < vans.length; i++) {
            let vanName = vans[i].querySelector('.vanName').innerHTML
            let vanLocation = vans[i].querySelector('.vanLocation').innerHTML
            let vanId = vans[i].querySelector(".vanId").innerHTML
            let vanbtn = vans[i].querySelector("#chooseVan")
            vanbtn.addEventListener('click', function () {

                const options = {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ 'vanName': vanName }),
                    redirect: 'follow'
                }
                try {
                    url = window.location.href
                    fetch(url, options).then(res => {
                        if (res.redirected) {
                            window.location.href = "/customer/menu/van=" + vanName
                        }
                    })
                }
                catch (err) {
                    console.log(err)
                }
            })
        }


        window.onload = async function () {
            L.mapquest.key = 'A1HigpvtAiVmfrECeAqUXlsnN6wDUshM';
            let vans = document.querySelectorAll('.vanListing')
            var map = L.mapquest.map('map', {
                center: [-37.816166, 144.966639],
                layers: L.mapquest.tileLayer('map'),
                zoom: 15
            });
            let geocoder = L.mapquest.geocoding();
            for (i = 0; i < vans.length; i++) {
                let vanName = vans[i].querySelector('.vanName').innerHTML
                let vanLocation = vans[i].querySelector('.vanLocation').innerHTML
                let vanId = vans[i].querySelector(".vanId").innerHTML

                await geocoder.geocode(vanLocation, geocodingCallback);

                function geocodingCallback(error, result) {
                    let coordinate = [result.results[0].locations[0].latLng.lat, result.results[0].locations[0].latLng.lng]
                    L.mapquest.textMarker(coordinate, {
                        text: vanName,
                        position: 'right',
                        type: 'marker',
                        title: vanId,
                        icon: {
                            primaryColor: '#333333',
                            secondaryColor: '#333333',
                            size: 'sm'
                        }
                    }).addTo(map);
                }
            }
        }
    </script>
</section>